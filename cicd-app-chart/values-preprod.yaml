# Preprod-specific values
# This file contains configuration optimized for ephemeral preprod environments
# These values override the default values.yaml for pull request deployments

# Environment identifier (will be overridden by workflow with PR number)
environment: preprod
prNumber: ""  # Will be set dynamically: pr-123

# Reduced replica count for preprod (save resources)
replicaCount: 1

# Image configuration
image:
  repository: damienmathieu/city-api
  pullPolicy: Always
  # Tag will be overridden to match the PR branch
  tag: latest

appKey: 'Pg_e79wvsahZGUYC5dmZ3c2BpmUteW_l'

# PostgreSQL configuration for preprod
# We use the shared PostgreSQL from the default namespace (production)
# Each preprod gets its own database within that shared PostgreSQL instance
postgresql:
  enabled: false  # Don't deploy a separate PostgreSQL for preprod

# Shared PostgreSQL connection settings
# Preprods connect to the production PostgreSQL instance in default namespace
sharedPostgres:
  # Service name of the production PostgreSQL
  host: "cicd-project-nodejs-postgresql.default.svc.cluster.local"
  port: 5432
  # Auth credentials (same as production)
  auth:
    username: root
    password: root
    # Production database name (used as source for cloning)
    productionDatabase: app
    # Preprod database name pattern: app_preprod_pr_{number}
    # Will be created by init container

# Service configuration
service:
  type: NodePort  # Use NodePort for easy access in preprod
  port: 80
  # NodePort will be calculated: 30000 + PR number
  # Example: PR #123 -> NodePort 30123
  nodePort: null  # Will be set dynamically by workflow

# Ingress configuration for preprod
# Host will be automatically generated as: pr-{NUMBER}.app.local
ingress:
  enabled: true
  className: 'traefik'
  domain: 'app.local'
  annotations: {}

# Reduced resource limits for preprod app
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Health checks (same as prod but with more lenient timeouts)
livenessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 5

readinessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Autoscaling disabled for preprod
autoscaling:
  enabled: false

# Pod labels for identification
podLabels:
  environment: preprod

# Pod annotations
podAnnotations:
  # Add PR info for visibility
  app.kubernetes.io/environment: preprod
